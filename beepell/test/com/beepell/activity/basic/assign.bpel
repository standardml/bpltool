<?xml version="1.0" encoding="ISO-8859-1"?>

<process
  name="proxy"
  targetNamespace="http://beepell.com/samples/proxy"
  xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
  xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
  xmlns:srv="http://beepell.com/samples/proxy/definitions"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns:tim="http://tim.hallwyl.dk/"
  xmlns:ins="http://tim.hallwyl.dk/insurance"
  xmlns:sref="http://docs.oasis-open.org/wsbpel/2.0/serviceref">

  <import importType="http://schemas.xmlsoap.org/wsdl/" namespace="http://beepell.com/samples/proxy/definitions" location="assign.wsdl" />   
  <import importType="http://schemas.xmlsoap.org/wsdl/" namespace="http://tim.hallwyl.dk/" location="insurance.wsdl" />   
  <import importType="http://www.w3.org/2001/XMLSchema" namespace="http://docs.oasis-open.org/wsbpel/2.0/serviceref" location="../../../../../schemas/sref.xsd" />   

  <partnerLinks>
    <partnerLink
      name="echoPartnerLink"
      partnerLinkType="srv:echoPartnerLinkType"
      myRole="echoProviderRole" />
    <partnerLink
      name="insurancePartnerLink"
      partnerLinkType="tim:insurancePartnerLinkType"
      partnerRole="insuranceProviderRole"
      initializePartnerRole="yes" />    
  </partnerLinks>
  
  <variables>
    <variable name="request" messageType="srv:echoMessage" />
    <variable name="insurance" messageType="tim:InsuranceRequest" />
        
    <variable name="ia" type="xsd:int" />
    <variable name="ib" type="xsd:int" />
    <variable name="ic" type="xsd:int" />
        
    <variable name="ba" type="xsd:boolean" />
    
    <variable name="sa" type="xsd:string" />
    
    <variable name="myEndpoint" element="sref:service-ref" />
    <variable name="partnerEndpoint" element="sref:service-ref" />
    
    <variable name="driver" type="ins:person" />
    
  </variables>
  
  <sequence suppressJoinFailure="yes">
    
    <receive
      partnerLink="echoPartnerLink"
      operation="echoOperation"
      variable="request"
      createInstance="yes"/>

    <assign validate="yes">
      <documentation>prepare variables for tests</documentation>
      <copy>
        <from>
          <literal>42</literal>
        </from>
        <to variable="ia" />
      </copy>
    </assign>





    <assign validate="yes">
      <documentation>test variable variant from-spec</documentation>
      <copy>
        <from variable="ia" />
        <to variable="ib" />
      </copy>
      <copy>
        <from variable="request" part="text" />
        <to variable="sa" />
      </copy>
      <copy>
        <from variable="request" part="text">
          <query>string-length(self::node())</query>
        </from>
        <to variable="ic" />
      </copy>
      <copy>
        <from variable="request">
          <query>$ia + $ib + $ic</query>
        </from>
        <to variable="ic" />
      </copy>
    </assign>

    <if>
      <condition>$ib != 42 or $sa != 'Hello world!' or $ic != 96</condition>
      <assign>
        <copy>
          <from><literal>FAILED</literal></from>
          <to variable="request" part="text" />
        </copy>
      </assign>
    </if>


    <assign validate="yes">
      <documentation>test partner link variant from-spec</documentation>
      <copy>
        <from partnerLink="echoPartnerLink" endpointReference="myRole" />
        <to variable="myEndpoint" />
      </copy>
      <copy>
        <from partnerLink="insurancePartnerLink" endpointReference="partnerRole" />
        <to variable="partnerEndpoint" />
      </copy>
    </assign>

    <if>
      <condition xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/">$myEndpoint/wsdl:port/soap:address/@location != 'http://localhost:9090/samples/proxy/definitions/echo'</condition>
      <assign>
        <copy>
          <from><literal>FAILED</literal></from>
          <to variable="request" part="text" />
        </copy>
      </assign>
    </if>

    <if>
      <condition xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/">$partnerEndpoint/wsdl:port/soap:address/@location != 'http://localhost:9010/samples/services/Insurance'</condition>
      <assign>
        <copy>
          <from><literal>FAILED</literal></from>
          <to variable="request" part="text" />
        </copy>
      </assign>
    </if>

    <assign validate="no" name="literal">
      <documentation>test literal variant from-spec</documentation>
      <copy>
        <from><literal><driver xmlns:ins="http://tim.hallwyl.dk/insurance"><ins:firstname>Peter</ins:firstname><ins:lastname>Ulrich</ins:lastname></driver></literal></from>
        <to variable="insurance" part="driver" />
      </copy>
    </assign>

    <if>
      <condition xmlns:ins="http://tim.hallwyl.dk/insurance">$insurance.driver/ins:firstname != 'Peter' or $insurance.driver/ins:lastname != 'Ulrich'</condition>
      <assign>
        <copy>
          <from><literal>FAILED</literal></from>
          <to variable="request" part="text" />
        </copy>
      </assign>
    </if>


    <assign validate="yes">
      <documentation>test property variant from-spec</documentation>
      <copy>
        <from variable="insurance" property="tim:firstname" />
        <to variable="sa" />
      </copy>
    </assign>
    
    <if>
      <condition>$sa != 'Peter'</condition>
      <assign>
        <copy>
          <from><literal>FAILED</literal></from>
          <to variable="request" part="text" />
        </copy>
      </assign>
    </if>	


    <assign validate="yes">
      <documentation>test expression variant from-spec</documentation>
      <copy>
        <from xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/">$myEndpoint/wsdl:port/soap:address/@location</from>
        <to variable="sa" />
      </copy>
      <copy>
        <from>string-length('even more') + 11</from>
        <to variable="ia" />
      </copy>
    </assign>
    
    <if>
      <condition>$ia != 20 or $sa != 'http://localhost:9090/samples/proxy/definitions/echo'</condition>
      <assign>
        <copy>
          <from><literal>FAILED</literal></from>
          <to variable="request" part="text" />
        </copy>
      </assign>
    </if>
    
    
    <reply
      partnerLink="echoPartnerLink"
      operation="echoOperation"
      variable="request"/>
    
  </sequence>  
  
</process>
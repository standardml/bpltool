<?xml version="1.0" encoding="ISO-8859-1"?>

<process
  name="proxy"
  targetNamespace="http://beepell.com/samples/proxy"
  xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
  xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
  xmlns:srv="http://beepell.com/samples/proxy/definitions"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns:tim="http://tim.hallwyl.dk/"
  xmlns:ins="http://tim.hallwyl.dk/insurance"
  xmlns:sref="http://docs.oasis-open.org/wsbpel/2.0/serviceref">

  <import importType="http://schemas.xmlsoap.org/wsdl/" namespace="http://beepell.com/samples/proxy/definitions" location="foreach.wsdl" />   

  <partnerLinks>
    <partnerLink
      name="echoPartnerLink"
      partnerLinkType="srv:echoPartnerLinkType"
      myRole="echoProviderRole" />
  </partnerLinks>
  
  <variables>
    <variable name="request" messageType="srv:echoMessage" />
    <variable name="i" type="xsd:int"><from><literal>0</literal></from></variable>
  </variables>
  
  <sequence>
      <receive
      partnerLink="echoPartnerLink"
      operation="echoOperation"
      variable="request"
      createInstance="yes"/>
   
   <forEach counterName="time" parallel="yes">
     <startCounterValue>$i + 1</startCounterValue>
     <finalCounterValue>$i + 5</finalCounterValue>

     <completionCondition>
       <branches successfulBranchesOnly="yes">
         $i + 3
       </branches>
     </completionCondition>

     <scope>
       <sequence>
       <wait>
         <for>concat('PT', ($time) ,'S')</for>
       </wait>
       <assign validate="no">
         <copy>
           <from>$i + 1</from>
           <to variable="i" />
         </copy>
       </assign>
       </sequence>
     </scope>

   </forEach>

   <forEach counterName="time" parallel="no">
     <startCounterValue>$i</startCounterValue>
     <finalCounterValue>$i + 5</finalCounterValue>

     <completionCondition>
       <branches successfulBranchesOnly="yes">
         $i
       </branches>
     </completionCondition>

     <scope>
       <sequence>
       <wait>
         <for>concat('PT', ($time - 2) ,'S')</for>
       </wait>
       <assign validate="no">
         <copy>
           <from>$i + 1</from>
           <to variable="i" />
         </copy>
       </assign>
       </sequence>
     </scope>

   </forEach>

   <assign validate="no">
     <copy>
       <from>$i</from>
       <to variable="request" part="text" />
     </copy>
   </assign>
     
   <reply
     partnerLink="echoPartnerLink"
     operation="echoOperation"
     variable="request"/>
  
  </sequence>  
  
</process>
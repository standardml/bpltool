<?xml version="1.0" encoding="ISO-8859-1"?>

<process
  name="proxy"
  targetNamespace="http://beepell.com/samples/proxy"
  xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
  xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
  xmlns:srv="http://beepell.com/samples/proxy/definitions"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns:tim="http://tim.hallwyl.dk/"
  xmlns:ins="http://tim.hallwyl.dk/insurance"
  xmlns:sref="http://docs.oasis-open.org/wsbpel/2.0/serviceref">

  <import importType="http://schemas.xmlsoap.org/wsdl/" namespace="http://beepell.com/samples/proxy/definitions" location="pick2.wsdl" />   

  <partnerLinks>
    
    <partnerLink
      name="textPartnerLink"
      partnerLinkType="srv:textPartnerLinkType"
      myRole="textProviderRole" />

    <partnerLink
      name="numberPartnerLink"
      partnerLinkType="srv:numberPartnerLinkType"
      myRole="numberProviderRole" />
    
  </partnerLinks>
  
  <variables>
    <variable name="textRequest" messageType="srv:textMessage" />
    <variable name="numberRequest" messageType="srv:numberMessage" />
  </variables>
  
  <sequence>
    
    <receive
      partnerLink="textPartnerLink"
      operation="textOperation"
      variable="textRequest"
      createInstance="yes"/>

    <pick createInstance="no">
      <onMessage
        partnerLink="numberPartnerLink"
        operation="numberOperation"
        variable="numberRequest">
        
        <sequence>
        <assign validate="yes">
          <copy>
            <from>$numberRequest.number + 42</from>
            <to variable="numberRequest" part="number" />
          </copy>
        </assign>

        <reply
          partnerLink="numberPartnerLink"
          operation="numberOperation"
          variable="numberRequest"/>
        </sequence>
    
      </onMessage>
      <onAlarm>
        <for>'PT2S'</for>
        <assign validate="yes">
          <copy>
            <from><literal>timeout</literal></from>
            <to variable="textRequest" part="text" />
          </copy>
        </assign>
      </onAlarm>
      <onAlarm>
        <for>'PT5S'</for>
        <assign validate="yes">
          <copy>
            <from><literal>timeout-failure</literal></from>
            <to variable="textRequest" part="text" />
          </copy>
        </assign>
      </onAlarm>
    </pick>
    
    
    <reply
      partnerLink="textPartnerLink"
      operation="textOperation"
      variable="textRequest"/>
    
  </sequence>  
  
</process>
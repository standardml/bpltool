<?xml version="1.0" encoding="ISO-8859-1"?>

<process
  name="repeatUntil"
  targetNamespace="http://beepell.com/samples/proxy"
  xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
  xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
  xmlns:srv="http://beepell.com/samples/proxy/definitions"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema">

  <import
    namespace="http://beepell.com/samples/proxy/definitions"
    location="./repeatUntil.wsdl"
    importType="http://schemas.xmlsoap.org/wsdl/" />

  <partnerLinks>
    <partnerLink
      name="clientPartnerLink"
      partnerLinkType="srv:serviceProviderPartnerLinkType"
      myRole="serviceProviderRole" />

    <partnerLink
      name="serverPartnerLink"
      partnerLinkType="srv:serviceProviderPartnerLinkType"
      myRole="serviceProviderRole" />

  </partnerLinks>

  <variables>
    <variable
      name="request"
      messageType="srv:requestMessage" />
    <variable
      name="response"
      messageType="srv:responseMessage" />
  </variables>

  <flow>
    <links>
      <link name="l1" />
      <link name="l2" />
    </links>

    <receive
      partnerLink="serverPartnerLink"
      operation="requestService"
      createInstance="yes"
      variable="request">
      <sources>
        <source linkName="l1" />
      </sources>
    </receive>
    
    <repeatUntil name="repeatUntil" suppressJoinFailure="yes">
      <targets>
        <bpel:joinCondition>$l1 or not($l1)</bpel:joinCondition>
        <target linkName="l1" />
      </targets>
      <sources>
        <source linkName="l2">
          <bpel:transitionCondition>true() or false()</bpel:transitionCondition>
        </source>
      </sources>
      <empty name="empty" />
      <condition>true()</condition>
    </repeatUntil>

    <reply
      partnerLink="proxyPartnerLink"
      operation="requestService"
      variable="response">
      <targets>
        <target linkName="l2" />
      </targets>
    </reply>

  </flow>
</process>
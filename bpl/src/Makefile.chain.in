# $Id: Makefile.chain,v 1.3 2006/04/29 09:09:56 hniss Exp $
#
# Include this from a subdirectory makefile, having first set
# DOWN = foo/bar/baz
# UP   = cd ../../..
# LOCAL = (possibly a list of files that can be made locally)
#
# This makefile fragment is distributed with the Mosmake system,
# but is not itself part of the system. You should probably copy it
# to the main project directory, such that you can adjust the suffix
# heuristics below to fit your project.
#
# Written by Henning Makholm in 2002.
# All copyright interest in this makefile is explicitly waived.
#
# This makefile is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  You get it
# for free; don't bother me about it.

MLYACC          = @MLYACC@
MLLEX           = @MLLEX@
DEP2SOURCES     = $(UP)/dep2sources.sh
export SED      = @SED@

phony_ALL: ; cd $(UP); $(MAKE)

COMMA = ,
LTGTS = phony_LOCAL $(LOCAL) $(patsubst %,%$(COMMA)smartmade,$(LOCAL))

.SUFFIXES:
$(LTGTS): %:    phony_FORCE ; cd $(UP); $(MAKE) $(DOWN)/$@
%.uo:           phony_FORCE ; cd $(UP); $(MAKE) $(DOWN)/$@
%.uo,smartmade: phony_FORCE ; cd $(UP); $(MAKE) $(DOWN)/$@
%.ui:           phony_FORCE ; cd $(UP); $(MAKE) $(DOWN)/$@
%.ui,smartmade: phony_FORCE ; cd $(UP); $(MAKE) $(DOWN)/$@
%.o:            phony_FORCE ; cd $(UP); $(MAKE) $(DOWN)/$@
%.o,smartmade:  phony_FORCE ; cd $(UP); $(MAKE) $(DOWN)/$@

.DEFAULT:       phony_FORCE ; cd $(UP); $(MAKE) $@

.PHONY: phony_FORCE phony_ALL
phony_FORCE:

%.lex.sml: %.lex
	   $(MLLEX) $<

%.grm-sig.sml %.grm.sig %.grm.sml: %.grm
	   $(MLYACC) $< && cp $*.grm.sig $*.grm-sig.sml

sources.cm: Dependencies $(DEP2SOURCES)
	$(DEP2SOURCES) -r $(UP) -c '/lib/compat/mosml/exception/.=/lib/compat/smlnj/exception/sources.cm' -c '/lib/compat/mosml/hash/.=/lib/compat/smlnj/sources.cm' -c '/lib/compat/mosml/word32/.=/lib/compat/smlnj/sources.cm' -c '/lib/compat/mosml/thread/.=/lib/compat/smlnj/thread/sources.cm' -c '/lib/compat/mosml/.=/lib/compat/smlnj/sources.cm' -x /lib/compat/mlton Dependencies $@

mlton.mlb: Dependencies
	@echo genmlton `pwd`
	@echo "(* Autogenerated file---DO NOT EDIT! *)" > $@
	@echo '$$(SML_LIB)/basis/basis.mlb' > $@
	@$(SED) -n \
	-e '/^# INCLUDE=/                { s/^# INCLUDE=\([^ \r]*\)/\1\/mlton.mlb/; p; }' \
	-e '/^# MLton:/                  { s/^# MLton:\([^ \r]*\)/\1/; p; }' \
	-e '/^[^:]*\.\(lex\|grm\)-sig:/  { s/:.*/.sml/; p; }' \
	-e '/^[^:]*\.\(lex\|grm\):/      { s/:.*/.sml/; p; }' \
	-e '/^[^.]*:/                    { s/:.*/.sml/; p; }' \
	< Dependencies >> $@

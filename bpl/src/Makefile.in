# Copyright (c) 2006  The BPL Group at the IT University of Copenhagen
#
# This file is part of BPL.
#
# BPL is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
#
# BPL is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with BPL; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301
# USA

# $Revision: 1.11 $

# Top makefile for BPL.  Targets include:
#
#   DIRTREE      - a description of the directory tree
#
#   doc          - API documentation for BDNF stuff, etc.
#
#   clean        - remove some mosmake files

@SET_MAKE@

SHELL		= /bin/bash

RM              = rm -f

MOSMLC  	= @MOSMLC@
PERL    	= @PERL@
MLYACC          = @MLYACC@
MLLEX           = @MLLEX@
SMLNJ           = @SMLNJ@
MLTON		= @MLTON@
MLC		= @MLC@

MAKEFILE	= Makefile
EXEEXT		= @EXEEXT@

MOSMLFLAGS 	= -liberal
DEPENDENCIES    := $(shell find . -name Dependencies)
MOSMAKEDIRS 	:= $(subst ./,, $(patsubst %/Dependencies,%,$(DEPENDENCIES)))
MOSMAKE 	= lib/mosmake

DOCDIR		= doc
SMLDOC		= smldoc
SMLDOC-FLAGS	= -d $(DOCDIR) --overview=overview.html --argfile=smldoc.cfg

ROOTDIR		= ..
THISDIR		= src
MKDIRTREE	= $(PWD)/mkdirtree
DESCFILES	= $(shell find . -name .description)

include $(MOSMAKE)/Makefile.inc


# Files to clean up
CLEANFILES :=
REALCLEANFILES :=
DISTCLEANFILES :=

# Automatic makefil'ing
.PHONY: ajour

ajour: configure $(MAKEFILE)

$(MAKEFILE): Makefile.chain

$(MAKEFILE) Makefile.chain: %: %.in config.status
	./config.status --file=$@ newdeps

config.status: configure
	./config.status --recheck

configure: configure.in
	autoconf

DISTCLEANFILES += config.cache config.log config.status Makefile Makefile.chain mosmake.dep


# Parsers and lexers
GRMFILES := $(shell find . -name '*.grm')
LEXFILES := $(shell find . -name '*.lex')
PARSINGFILES := $(patsubst %.grm,%.grm-sig.sml,$(GRMFILES)) $(patsubst %.grm,%.grm.sml,$(GRMFILES)) $(patsubst %.lex,%.lex.sml,$(LEXFILES))

%.lex.sml: %.lex
	cd $(dir $@) && $(MAKE) $(notdir $@)

%.grm-sig.sml %.grm.sml: %.grm
	cd $(dir $@) && $(MAKE) $(notdir $@)


# Documentation

.PHONY:	all doc upload-doc

doc:	$(DOCDIR)/index.html
$(DOCDIR)/index.html: smldoc.cfg overview.html sources.cm sources-smlnj.cm \
	bdnf/sources.cm lib/lib.cm bdnf/*.sml lib/*.sml
	test -w $(DOCDIR) || mkdir $(DOCDIR)
	$(SMLDOC) $(SMLDOC-FLAGS) sources.cm sources-smlnj.cm \
	bdnf/sources.cm lib/lib.cm

DIRTREE: $(DESCFILES) $(MKDIRTREE)
	echo "Directory summary (automatically generated, foolish to edit):" > $@
	echo "" >> $@
	cd $(ROOTDIR) && $(MKDIRTREE) $(THISDIR) >> $(THISDIR)/$@

upload-doc: doc
	scp doc/* ssh.itu.dk:/import/www/research/theory/bpl/doc/ml/doc/

# SML/NJ
kernel.cm: kernel.cm.in
	sed -e 's+@BPLSRCROOT@+$(CURDIR)+g' < $< > $@

%/sources.cm: %/Dependencies
	cd $(dir $@) && $(MAKE) $(notdir $@)

# MLton
%/mlton.mlb: %/Dependencies
	cd $(dir $@) && $(MAKE) $(notdir $@)

smlnj-prepare: $(patsubst %/Dependencies,%/sources.cm,$(DEPENDENCIES))
mlton-prepare: $(patsubst %/Dependencies,%/mlton.mlb,$(DEPENDENCIES)) 

.PHONY: smlnj-prepare mlton-prepare

# Testing
check: test

test: test-$(MLC)

test-mosml: unittest
	./unittest

test-smlnj: smlnj-prepare test.cm
	echo "CM.make' \"test.cm\";" | $(SMLNJ)

test-mlton: mlton-prepare $(PARSINGFILES)
	$(MLTON) test/mlton.mlb && test/mlton

.PHONY:	check test test-smlnj test-mosml test-mlton

# Clean up
clean:
	$(RM) *~ 

parsersclean:
	for g in $(GRMFILES); do $(RM) $$g.{desc,sig,-sig.sml,sml}; done
	for l in $(LEXFILES); do $(RM) $$l.sml; done


CMDIRS = $(filter-out lib/pp/smlnj,$(MOSMAKEDIRS))
cmclean:
	for d in $(CMDIRS); do [ -r $$d/Dependencies ] && $(RM) -f $$d/sources.cm; done

mlbclean:
	$(RM) $(patsubst %/Dependencies,%/mlton.mlb,$(DEPENDENCIES)) 

realclean: clean cmclean mlbclean parsersclean

distclean: realclean
	$(RM) -rf autom4te.cache
	$(RM) $(DISTCLEANFILES)

.PHONY: parsersclean cmclean mlbclean clean realclean distclean

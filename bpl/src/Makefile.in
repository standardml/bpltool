# Copyright (c) 2006  The BPL Group at the IT University of Copenhagen
#
# This file is part of BPL.
#
# BPL is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
#
# BPL is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with BPL; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301
# USA

# $Revision: 1.11 $

# Top makefile for BPL.  Targets include:
#
#   DIRTREE      - a description of the directory tree
#
#   doc          - API documentation for BDNF stuff, etc.
#
#   clean        - remove some mosmake files

@SET_MAKE@

SHELL		= /bin/bash

RM              = rm -f

MOSMLC  	= @MOSMLC@
PERL    	= @PERL@
MLYACC          = @MLYACC@
MLLEX           = @MLLEX@
SMLNJ           = @SMLNJ@
MLTON		= @MLTON@

MAKEFILE	= Makefile
EXEEXT		= @EXEEXT@

MOSMLFLAGS 	= -liberal
DEPENDENCIES    := $(shell find . -name Dependencies)
MOSMAKEDIRS 	:= $(subst ./,, $(patsubst %/Dependencies,%,$(DEPENDENCIES)))
MOSMAKE 	= lib/mosmake

DOCDIR		= doc
SMLDOC		= smldoc
SMLDOC-FLAGS	= -d $(DOCDIR) --overview=overview.html --argfile=smldoc.cfg

ROOTDIR		= ../..
THISDIR		= code/ml
MKDIRTREE	= $(PWD)/mkdirtree
DESCFILES	= $(shell find . -name .description)

include $(MOSMAKE)/Makefile.inc


# Files to clean up
CLEANFILES :=
REALCLEANFILES :=
DISTCLEANFILES :=

# MLton
ifeq (,$(MLTON))
  MLTON_DEPENDS :=
else
  MLTON_DEPENDS :=
#  MLTON_DEPENDS := $(shell $(MLTON) -stop f test/mlton.mlb)
endif

# Automatic makefil'ing
.PHONY: ajour

ajour: configure $(MAKEFILE)

$(MAKEFILE): Makefile.chain

$(MAKEFILE) Makefile.chain: %: %.in config.status
	./config.status --file=$@ newdeps

config.status: configure
	./config.status --recheck

configure: configure.in
	autoconf

DISTCLEANFILES += config.cache config.log config.status Makefile Makefile.chain mosmake.dep


# Parsers and lexers
%.lex.sml: %.lex
	cd $(dir $@) && $(MAKE) $(notdir $@)

%.grm-sig.sml %.grm.sml: %.grm
	cd $(dir $@) && $(MAKE) $(notdir $@)


# Documentation

.PHONY:	all doc upload-doc

doc:	$(DOCDIR)/index.html
$(DOCDIR)/index.html: smldoc.cfg overview.html sources.cm sources-smlnj.cm \
	bdnf/sources.cm lib/lib.cm bdnf/*.sml lib/*.sml
	test -w $(DOCDIR) || mkdir $(DOCDIR)
	$(SMLDOC) $(SMLDOC-FLAGS) sources.cm sources-smlnj.cm \
	bdnf/sources.cm lib/lib.cm

DIRTREE: $(DESCFILES)
	echo "Directory summary (automatically generated, foolish to edit):" > $@
	echo "" >> $@
	cd $(ROOTDIR) && $(MKDIRTREE) $(THISDIR) >> $(THISDIR)/$@

upload-doc: doc
	scp doc/* ssh.itu.dk:/import/www/research/theory/bpl/doc/ml/doc/

# SML/NJ
%/sources.cm: %/sources.cm.in
	cd $(dir $@) && $(MAKE) $(notdir $@)

%.cm: %.cm.in Dependencies
	echo "(* Autogenerated file---DO NOT EDIT! *)" > $@
	cat $*.cm.in >> $@
	sed -n \
	-e '/^[^:]*\.\(lex\|grm\)-sig:/  b;' \
	-e '/^[^:]*\.\(lex\|grm\):/      { s/:.*//; p; b; }' \
	-e '/^[^.]*:/                 { s/:.*/.sml/; p; }' \
	< Dependencies >> $@

# MLton
%/mlton.mlb: %/Dependencies
	cd $(dir $@) && $(MAKE) $(notdir $@)

mlton-prepare: $(patsubst %/Dependencies,%/mlton.mlb,$(DEPENDENCIES)) 

.PHONY: mlton-prepare

# Testing
check: test

test: test-mosml

test-mosml: unittest
	./unittest

#test-mlton: mlton-prepare $(MLTON_DEPENDS)
#	mlton test/mlton.mlb
#	./unittest

.PHONY:	check test test-smlnj test-mosml test-mlton

# Clean up
GRMFILES := $(shell find . -name '*.grm')
LEXFILES := $(shell find . -name '*.lex')

clean:
	$(RM) *~ 

parsersclean:
	for g in $(GRMFILES); do $(RM) $$g.{desc,sig,-sig.sml,sml}; done
	for l in $(LEXFILES); do $(RM) $$l.sml; done

cmclean:
	for d in $(MOSMAKEDIRS); do $(RM) -rf $$d/.cm; done

realclean: clean cmclean parsersclean

distclean: realclean
	$(RM) -rf autom4te.cache
	$(RM) $(DISTCLEANFILES)

.PHONY: parsersclean cmclean clean realclean distclean
